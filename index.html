<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Generador de Etiquetas • GoSpin (v1.8.1)</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{ --ink:#0f172a; --muted:#64748b; --brand:#0ea5e9; --danger:#b91c1c; --danger-bg:#ffeaea; }
  *{ box-sizing:border-box }
  html{ -webkit-text-size-adjust:100%; }
  html, body{ overflow-x:hidden; }
  body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; margin:0; background:#fff; color:var(--ink); }

  .page{ max-width:1200px; margin:0 auto; padding:0 20px; }
  @media (max-width:980px){ .page{ padding:0 12px; } }

  header{ background:#fff; border-bottom:1px solid #e6e8eb; }
  header .page{ display:flex; align-items:center; gap:14px; padding:16px 20px; }
  header h1{ font-size:18px; margin:0; font-weight:800 }
  @media (max-width:980px){ header .page{ padding:12px; } header h1{ font-size:16px; } }

  main .page{
    padding-top:20px; padding-bottom:20px;
    display:grid; grid-template-columns:420px 1fr; gap:20px; align-items:stretch;
    min-height:calc(100vh - 80px);
  }
  @media (max-width:980px){
    main .page{ grid-template-columns:1fr; min-height:auto; padding-top:12px; padding-bottom:12px; gap:12px; }
  }

  .card{ background:#fff; border:1px solid #e6e8eb; border-radius:14px; box-shadow:0 10px 20px rgba(0,0,0,.04); height:100%; display:flex; flex-direction:column; }
  .card .card-body{ padding:18px; display:flex; flex-direction:column; gap:12px; flex:1 }

  /* -------- AVISO DE ERRORES -------- */
  .alert{ display:none; background:var(--danger-bg); border:1px solid #fecaca; color:var(--danger); border-radius:10px; padding:12px 12px; font-size:14px; }
  .alert-title{ font-weight:800; display:flex; align-items:center; gap:8px; margin:0 0 6px 0 }
  .alert ul{ margin:0; padding-left:18px }
  .alert svg{ width:18px; height:18px; flex:0 0 auto }

  /* -------- FORMATO (arriba del todo) -------- */
  .options{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-size:13px; color:#475569; }
  .options .group{ padding:10px; border:1px solid #e6e8eb; border-radius:10px; background:#fff; }
  .options label{ display:inline-flex; align-items:center; gap:6px; margin-right:10px; cursor:pointer; }

  /* -------- FORM -------- */
  .field label{ display:block; font-size:12px; font-weight:800; margin-bottom:6px }
  .field input,.field textarea{ width:100%; border:1px solid #cfd3d7; border-radius:10px; font-size:14px; background:#fff; transition:border-color .15s }
  .field input{ height:44px; padding:8px 12px; line-height:1.15 }
  .row{ display:grid; grid-template-columns:1fr 180px; gap:10px }
  .field textarea{ min-height:64px; padding:10px 12px; line-height:1.15; resize:vertical }
  .invalid{ border-color:#ef4444 !important; }
  @media (max-width:980px){ .field input,.field textarea{ font-size:16px; } }

  .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:auto }
  button{ appearance:none; border:0; background:var(--brand); color:#fff; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer }
  button.secondary{ background:#e2e8f0; color:#0f172a }

  @media (max-width:980px){
    body{ padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px)); }
    .actions{
      position:fixed; left:12px; right:12px; bottom:calc(28px + env(safe-area-inset-bottom, 0px));
      background:#fff; padding:12px; border:1px solid #e5e7eb; border-radius:12px;
      box-shadow:0 6px 24px rgba(0,0,0,0.10); justify-content:center; z-index:999;
    }
    .actions button{ flex:1; max-width:200px }
  }

  /* -------- PREVIEW (derecha) -------- */
  .preview-card .card-body{ padding:16px; gap:10px }
  .status{ font-size:13px; color:#475569; }
  .preview-wrap{ display:flex; flex-direction:column; gap:10px; overflow:auto; }

  /* Etiqueta (reutilizamos diseño) */
  .label-preview{ width:95mm; height:142.5mm; background:#fff; color:#000; position:relative; border:1px solid #d1d5db; }
  .label-box{ position:absolute; inset:6.65mm; border:1.3px solid #000; padding:4.3mm; display:flex; flex-direction:column; gap:2.3mm }
  .brand-row{ display:grid; grid-template-columns:1fr auto; align-items:center }
  .brand-title{ font-weight:900; font-size:11.2px; letter-spacing:.2px }
  .brand-logo{ width:17mm; height:auto; object-fit:contain }

  .fieldbox{ display:flex; flex-direction:column; gap:.75mm }
  .flabel{ font-size:8.8px; font-weight:900 }
  .box{ border:1px solid #000; padding:2.3mm; min-height:9.5mm; font-size:11.2px; line-height:1.12; white-space:pre-wrap; word-wrap:break-word }
  .row2{ display:grid; grid-template-columns:1fr 26.5mm; gap:2.4mm; align-items:start }
  .cp .box{ font-size:13.4px; font-weight:400; text-align:left }
  .cel .box{ font-size:11.2px; font-weight:400 }
  .obs .box{ min-height:12.8mm }
  .website{ text-align:center; font-weight:900; font-size:10.2px; margin-top:auto }

  /* PRINT */
  @page{ size:100mm 150mm; margin:0 } /* ignorado en PDFs generados */
  @media print{
    header, .card:not(.printable), .preview-wrap{ display:none !important }
    body{ background:#fff !important; padding-bottom:0 !important }
  }
</style>
</head>
<body>
  <header>
    <div class="page">
      <h1>Generador de Etiquetas (10×15 cm) • GoSpin (v1.8.1)</h1>
    </div>
  </header>

  <main>
    <div class="page">
      <!-- PANEL IZQUIERDO -->
      <section class="card form-card printable">
        <div class="card-body">

          <!-- Formato arriba del todo -->
          <div class="options">
            <div class="group">
              <strong style="font-size:12px; color:#0f172a; display:block; margin-bottom:6px;">Formato</strong>
              <label><input type="radio" name="pdfsize" value="a4x4_95" checked> A4 · <b>4 por hoja</b> (95%, vertical)</label>
              <label><input type="radio" name="pdfsize" value="10x15"> Térmica 10×15 (100%)</label>
            </div>
          </div>

          <!-- Aviso de errores -->
          <div id="error-box" class="alert" role="alert" aria-live="polite">
            <p class="alert-title">
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M11.001 10h2v5h-2v-5zm0 6h2v2h-2v-2z"/><path d="M1 21h22L12 2 1 21z"/></svg>
              <span>Faltan completar los siguientes campos:</span>
            </p>
            <ul id="error-list"></ul>
          </div>

          <!-- Formulario -->
          <div class="field">
            <label>REMITENTE</label>
            <input id="f-remitente" maxlength="64" placeholder="(Ingresar únicamente nombre de comercio)"/>
          </div>
          <div class="field">
            <label>NOMBRE COMPLETO DE QUIEN RECIBE</label>
            <input id="f-nombre" maxlength="64" placeholder="(Nombre y Apellido)"/>
          </div>
          <div class="field">
            <label>DOMICILIO</label>
            <input id="f-domicilio" maxlength="90" placeholder="(Calle, Número, Piso/Departamento)"/>
          </div>
          <div class="row">
            <div class="field">
              <label>LOCALIDAD</label>
              <input id="f-localidad" maxlength="48" placeholder="(Ciudad/Localidad)"/>
            </div>
            <div class="field">
              <label>CÓDIGO POSTAL</label>
              <input id="f-cp" inputmode="numeric" maxlength="4" placeholder="(4 dígitos, ej. 1602)"/>
            </div>
          </div>
          <div class="field">
            <label>CELULAR</label>
            <input id="f-cel" inputmode="numeric" maxlength="15" placeholder="(Sólo números, sin + ni guiones)"/>
          </div>
          <div class="field">
            <label>OBSERVACIONES</label>
            <textarea id="f-obs" rows="3" maxlength="220" placeholder="(Frágil, horario de entrega, portería, etc.)"></textarea>
          </div>

          <div class="actions">
            <button id="btn-pdf">Descargar PDF</button>
            <button id="btn-clear" class="secondary">Nueva etiqueta</button>
          </div>
          <p style="font-size:12px; color:#475569; margin:6px 0 0">
            Todos los campos son obligatorios salvo Observaciones. Los datos no se envían a ningún servidor.
          </p>
        </div>
      </section>

      <!-- PANEL DERECHO -->
      <section class="card preview-card">
        <div class="card-body">
          <div class="status">Etiquetas en esta hoja (A4): <b id="count">0</b> / 4</div>

          <!-- Vista A4 (vertical): lista vertical de etiquetas añadidas -->
          <div class="preview-wrap" id="a4-area">
            <div id="labels-list" style="display:flex; flex-direction:column; gap:10px;"></div>
          </div>

          <!-- Vista individual (térmica) -->
          <div class="preview-wrap" id="single-area" style="display:none">
            <div class="label-preview" id="single-preview">
              <div class="label-box">
                <div class="brand-row">
                  <div class="brand-title">Etiqueta de Envío • GoSpin</div>
                  <img src="gospinlogo.png" alt="GoSpin" class="brand-logo" />
                </div>
                <div class="fieldbox remitente"><div class="flabel">REMITENTE</div><div class="box" id="v-remitente"></div></div>
                <div class="fieldbox nombre"><div class="flabel">NOMBRE COMPLETO DE QUIEN RECIBE</div><div class="box" id="v-nombre"></div></div>
                <div class="fieldbox domicilio"><div class="flabel">DOMICILIO</div><div class="box" id="v-domicilio"></div></div>
                <div class="row2">
                  <div class="fieldbox loc"><div class="flabel">LOCALIDAD</div><div class="box" id="v-localidad"></div></div>
                  <div class="fieldbox cp"><div class="flabel">CÓDIGO POSTAL</div><div class="box" id="v-cp"></div></div>
                </div>
                <div class="fieldbox cel"><div class="flabel">CELULAR</div><div class="box" id="v-cel"></div></div>
                <div class="fieldbox obs"><div class="flabel">OBSERVACIONES</div><div class="box" id="v-obs"></div></div>
                <div class="website">WWW.GOSPIN.COM.AR</div>
              </div>
            </div>
          </div>

        </div>
      </section>

    </div>
  </main>

<script>
function $(id){return document.getElementById(id);}
function getVal(id){return ($(id).value||'').trim();}
function setInvalid(id, on){ $(id).classList.toggle('invalid', !!on); }

const MAX_PER_SHEET = 4;
let labels = []; // etiquetas agregadas (A4)

function validateAll(){
  const missing = [];
  const order = ['f-remitente','f-nombre','f-domicilio','f-localidad','f-cp','f-cel'];
  order.forEach(id=>setInvalid(id,false));
  if(!getVal('f-remitente')) missing.push('Remitente'), setInvalid('f-remitente',true);
  if(!getVal('f-nombre'))    missing.push('Nombre completo de quien recibe'), setInvalid('f-nombre',true);
  if(!getVal('f-domicilio')) missing.push('Domicilio'), setInvalid('f-domicilio',true);
  if(!getVal('f-localidad')) missing.push('Localidad'), setInvalid('f-localidad',true);
  const cp=getVal('f-cp'); if(!/^\d{4}$/.test(cp)) missing.push('Código Postal (4 dígitos)'), setInvalid('f-cp',true);
  const cel=getVal('f-cel'); if(!/^\d{1,15}$/.test(cel)) missing.push('Celular (sólo números, hasta 15 dígitos)'), setInvalid('f-cel',true);
  const ok = missing.length===0;
  return { ok, missing, first: ok?null:order.find(id => $(id).classList.contains('invalid')) };
}

function renderErrors(list){
  const box=$('error-box'), ul=$('error-list');
  if(!list || list.length===0){ box.style.display='none'; ul.innerHTML=''; return; }
  ul.innerHTML=list.map(t=>`<li>${t}</li>`).join('');
  box.style.display='block';
}

/* filtros numéricos */
$('f-cp').addEventListener('input',e=>{ e.target.value=e.target.value.replace(/[^0-9]/g,'').slice(0,4); });
$('f-cel').addEventListener('input',e=>{ e.target.value=e.target.value.replace(/[^0-9]/g,'').slice(0,15); });

/* sincroniza preview individual (térmica) y oculta banner si todo ok */
function syncSingle(){
  ['remitente','nombre','domicilio','localidad','cp','cel','obs'].forEach(x=>$('v-'+x).textContent=getVal('f-'+x));
  const v=validateAll(); if(v.ok){ renderErrors([]); }
}
['f-remitente','f-nombre','f-domicilio','f-localidad','f-cp','f-cel','f-obs'].forEach(id=>$(id).addEventListener('input',syncSingle));

/* construir una etiqueta DOM */
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function buildLabelNode(data){
  const wrap=document.createElement('div');
  wrap.className='label-preview';
  wrap.innerHTML = `
    <div class="label-box">
      <div class="brand-row">
        <div class="brand-title">Etiqueta de Envío • GoSpin</div>
        <img src="gospinlogo.png" alt="GoSpin" class="brand-logo" />
      </div>
      <div class="fieldbox remitente"><div class="flabel">REMITENTE</div><div class="box">${escapeHTML(data.remitente)}</div></div>
      <div class="fieldbox nombre"><div class="flabel">NOMBRE COMPLETO DE QUIEN RECIBE</div><div class="box">${escapeHTML(data.nombre)}</div></div>
      <div class="fieldbox domicilio"><div class="flabel">DOMICILIO</div><div class="box">${escapeHTML(data.domicilio)}</div></div>
      <div class="row2">
        <div class="fieldbox loc"><div class="flabel">LOCALIDAD</div><div class="box">${escapeHTML(data.localidad)}</div></div>
        <div class="fieldbox cp"><div class="flabel">CÓDIGO POSTAL</div><div class="box">${escapeHTML(data.cp)}</div></div>
      </div>
      <div class="fieldbox cel"><div class="flabel">CELULAR</div><div class="box">${escapeHTML(data.cel)}</div></div>
      <div class="fieldbox obs"><div class="flabel">OBSERVACIONES</div><div class="box">${escapeHTML(data.obs)}</div></div>
      <div class="website">WWW.GOSPIN.COM.AR</div>
    </div>
  `;
  return wrap;
}

/* redibuja lista vertical de etiquetas (preview A4 en web) */
function renderList(){
  const list=$('labels-list');
  list.innerHTML='';
  labels.forEach(d=>list.appendChild(buildLabelNode(d)));
  $('count').textContent=String(labels.length);
}

/* modo UI (A4 vs térmica) */
function updateModeUI(){
  const mode=(document.querySelector('input[name="pdfsize"]:checked')||{}).value||'a4x4_95';
  const isA4 = (mode==='a4x4_95');
  $('a4-area').style.display = isA4 ? '' : 'none';
  $('single-area').style.display = isA4 ? 'none' : '';
  // contador visible siempre en A4
}

/* auto-agregar cuando todo está válido (Enter o blur de Celular) */
['f-remitente','f-nombre','f-domicilio','f-localidad','f-cp','f-cel'].forEach(id=>{
  $(id).addEventListener('keydown',e=>{
    if(e.key==='Enter'){ e.preventDefault(); tryAutoAdd(); }
  });
});
$('f-cel').addEventListener('blur', tryAutoAdd);

function currentData(){
  return {
    remitente:getVal('f-remitente'),
    nombre:getVal('f-nombre'),
    domicilio:getVal('f-domicilio'),
    localidad:getVal('f-localidad'),
    cp:getVal('f-cp'),
    cel:getVal('f-cel'),
    obs:getVal('f-obs')
  };
}

function clearForm(){
  ['f-remitente','f-nombre','f-domicilio','f-localidad','f-cp','f-cel','f-obs'].forEach(id=>{ $(id).value=''; setInvalid(id,false); });
  syncSingle();
  $('f-remitente').focus();
}

function tryAutoAdd(){
  const mode=(document.querySelector('input[name="pdfsize"]:checked')||{}).value||'a4x4_95';
  if(mode!=='a4x4_95') return; // sólo auto-agrega en A4
  if(labels.length>=MAX_PER_SHEET) return;

  const v=validateAll();
  if(!v.ok){ renderErrors(v.missing); return; }
  renderErrors([]);

  labels.push(currentData());
  renderList();
  clearForm();
}

/* Descargar PDF */
async function descargarPDF(){
  const mode=(document.querySelector('input[name="pdfsize"]:checked')||{}).value||'a4x4_95';
  const { jsPDF } = window.jspdf;

  if(mode==='10x15'){
    // térmica: validación y una etiqueta
    const v=validateAll();
    if(!v.ok){ renderErrors(v.missing); if(v.first) $(v.first).focus(); return; }
    renderErrors([]);
    const pv=$('single-preview'), prev=pv.style.transform; pv.style.transform='none';
    const canvas=await html2canvas(pv,{scale:2,backgroundColor:'#fff'});
    const img=canvas.toDataURL('image/png');
    const pdf=new jsPDF({orientation:'p', unit:'mm', format:[100,150]});
    pdf.addImage(img,'PNG',0,0,100,150);
    const nombre=(getVal('f-nombre').replace(/[^A-Za-z0-9_\-]+/g,'_'))||'etiqueta';
    const cp=getVal('f-cp')||'0000';
    pdf.save(`etiqueta_gospin_${cp}_${nombre}_10x15.pdf`);
    pv.style.transform=prev;
    return;
  }

  // A4x4 (95%) — si no agregaron ninguna, intento agregar la actual si es válida
  if(labels.length===0){
    const v=validateAll();
    if(!v.ok){ renderErrors(v.missing); if(v.first) $(v.first).focus(); return; }
    labels.push(currentData());
    renderList();
    clearForm();
  }

  // Genero A4 VERTICAL (210 × 297 mm)
  const pdf = new jsPDF({orientation:'p', unit:'mm', format:'a4'});
  const pageW=210, pageH=297;

  // Renderizo cada etiqueta agregada a imagen
  const images=[];
  for(const node of $('labels-list').children){
    const prev=node.style.transform; node.style.transform='none';
    const canvas=await html2canvas(node,{scale:2,backgroundColor:'#fff'});
    node.style.transform=prev;
    images.push(canvas.toDataURL('image/png'));
  }

  // 2×2 a 95%: W=95mm, H=142.5mm
  const W=95, H=142.5, gutterX=10, gutterY=10;
  // centrar con pequeños márgenes: total ancho = 95*2 +10 = 200 -> margen horizontal 5mm
  // total alto = 142.5*2 +10 = 295 -> margen vertical 1mm
  const left = (pageW - (W*2 + gutterX)) / 2;  // 5
  const top  = (pageH - (H*2 + gutterY)) / 2;  // 1

  for(let i=0;i<images.length;i++){
    if(i>0 && i%4===0){ pdf.addPage('a4','p'); }
    const slot=i%4; // 0..3
    const row = Math.floor(slot/2); // 0..1
    const col = slot%2; // 0..1
    const x = left + col*(W + gutterX);
    const y = top  + row*(H + gutterY);
    pdf.addImage(images[i],'PNG',x,y,W,H);
  }

  const count = images.length;
  pdf.save(`etiquetas_gospin_A4x4_95_${count}.pdf`);

  // reset para próxima tarea
  labels=[]; renderList(); $('count').textContent='0';
}

/* Botones */
$('btn-pdf').addEventListener('click', descargarPDF);
$('btn-clear').addEventListener('click', ()=>{
  ['f-remitente','f-nombre','f-domicilio','f-localidad','f-cp','f-cel','f-obs'].forEach(id=>{ $(id).value=''; setInvalid(id,false); });
  renderErrors([]); labels=[]; renderList(); $('count').textContent='0'; $('f-remitente').focus();
});

/* Cambios de formato */
document.querySelectorAll('input[name="pdfsize"]').forEach(r=>r.addEventListener('change', ()=>{
  updateModeUI();
}));

/* init */
updateModeUI();
renderList();
syncSingle();
</script>
</body>
</html>
