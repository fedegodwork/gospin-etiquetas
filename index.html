<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Generador de Etiquetas • GoSpin (v1.9.4)</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{ --ink:#0f172a; --muted:#64748b; --brand:#0ea5e9; --ok:#16a34a; --danger:#b91c1c; --danger-bg:#ffeaea; --border:#e6e8eb; }
  *{ box-sizing:border-box }
  html{ -webkit-text-size-adjust:100%; }
  html, body{ overflow-x:hidden; }
  body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; margin:0; background:#fff; color:var(--ink); }

  .page{ max-width:1200px; margin:0 auto; padding:0 20px; }
  @media (max-width:980px){ .page{ padding:0 12px; } }

  header{ background:#fff; border-bottom:1px solid var(--border); }
  header .page{ display:flex; align-items:center; gap:14px; padding:16px 20px; }
  header h1{ font-size:18px; margin:0; font-weight:800 }
  @media (max-width:980px){ header .page{ padding:12px; } header h1{ font-size:16px; } }

  main .page{
    padding-top:20px; padding-bottom:20px;
    display:grid; grid-template-columns:420px 1fr; gap:20px; align-items:stretch;
    min-height:calc(100vh - 80px);
  }
  @media (max-width:980px){
    main .page{ grid-template-columns:1fr; min-height:auto; padding-top:12px; padding-bottom:12px; gap:12px; }
  }

  .card{ background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 20px rgba(0,0,0,.04); height:100%; display:flex; flex-direction:column; }
  .card .card-body{ padding:18px; display:flex; flex-direction:column; gap:12px; flex:1 }

  .alert{ display:none; background:var(--danger-bg); border:1px solid #fecaca; color:var(--danger); border-radius:10px; padding:12px; font-size:14px; }
  .alert-title{ font-weight:800; display:flex; align-items:center; gap:8px; margin:0 0 6px 0 }
  .alert ul{ margin:0; padding-left:18px }
  .alert svg{ width:18px; height:18px; flex:0 0 auto }

  .options{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-size:13px; color:#475569; }
  .options .group{ padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff; }
  .options label{ display:inline-flex; align-items:center; gap:6px; margin-right:10px; cursor:pointer; }

  .selector{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .selector .tag{ border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:10px; font-size:13px; color:#0f172a; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px }
  .selector .tag small{ font-weight:700; color:#64748b }
  .selector .tag.active{ outline:2px solid var(--brand); }
  .dot{ width:10px; height:10px; border-radius:999px; background:#cbd5e1 }
  .dot.ok{ background:var(--ok) }
  .dot.edit{ background:var(--brand) }

  .field label{ display:block; font-size:12px; font-weight:800; margin-bottom:6px }
  .field input,.field textarea{ width:100%; border:1px solid #cfd3d7; border-radius:10px; font-size:14px; background:#fff; transition:border-color .15s }
  .field input{ height:44px; padding:8px 12px; line-height:1.15 }
  .row{ display:grid; grid-template-columns:1fr 180px; gap:10px }
  .field textarea{ min-height:64px; padding:10px 12px; line-height:1.15; resize:vertical }
  .invalid{ border-color:#ef4444 !important; }
  input[type="text"], textarea{ text-transform:uppercase; }

  .hint{ display:none; border:1px dashed #cbd5e1; background:#f8fafc; color:#0f172a; padding:10px 12px; border-radius:10px; font-size:13px }
  .hint b{ color:#0f172a }
  .hint .go{ margin-left:10px; background:var(--brand); color:#fff; border:0; border-radius:8px; padding:6px 10px; font-weight:800; cursor:pointer }

  .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px }
  button{ appearance:none; border:0; background:var(--brand); color:#fff; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer }
  button.secondary{ background:#e2e8f0; color:#0f172a }

  .preview-card .card-body{ padding:16px; gap:12px }
  .status{ font-size:13px; color:#475569; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

  .slots{
    display:grid;
    grid-template-columns: 1fr; /* móvil */
    justify-content:center;
    gap:12px;
    align-content:start;
  }
  @media (min-width:1024px){
    .slots{ grid-template-columns: 92mm 92mm; justify-content:center; }
  }

  .label-preview{ width:92mm; height:138mm; background:#fff; color:#000; position:relative; border:1px solid #d1d5db; border-radius:8px; cursor:pointer; overflow:hidden }
  .label-preview.active{ outline:3px solid #0ea5e9; outline-offset:0; }
  .badge{ position:absolute; top:6px; left:6px; background:rgba(15,23,42,.85); color:#fff; font-weight:800; font-size:11px; padding:3px 7px; border-radius:8px; z-index:2 }
  .placeholder{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:13px; font-weight:700; user-select:none; padding:8px; text-align:center }
  .placeholder b{ color:#64748b }

  .label-box{ position:absolute; inset:6.5mm; border:1.3px solid #000; padding:4.2mm; display:flex; flex-direction:column; gap:2.2mm }
  .brand-row{ display:grid; grid-template-columns:1fr auto; align-items:flex-start }
  .brand-left{ display:flex; flex-direction:column; gap:1mm }
  .brand-title{ font-weight:900; font-size:11.2px; letter-spacing:.2px }
  .brand-date{ font-size:9px; font-weight:700 }
  .brand-logo{ width:17mm; height:auto; object-fit:contain }

  .fieldbox{ display:flex; flex-direction:column; gap:.75mm }
  .flabel{ font-size:8.8px; font-weight:900 }
  .box{ border:1px solid #000; padding:2.2mm; min-height:9.2mm; font-size:11.2px; line-height:1.12; white-space:pre-wrap; word-wrap:break-word }

  /* Fila LOCALIDAD | CP (2 columnas) */
  .row2{ display:grid; grid-template-columns:1fr 26mm; gap:2.3mm; align-items:start }
  .cp .box{ font-size:13.2px; font-weight:400; text-align:left }

  .cel .box{ font-size:11.2px; font-weight:400 }
  .obs .box{ min-height:12.5mm }
  .website{ text-align:center; font-weight:900; font-size:10.2px; margin-top:auto }

  .single-wrap{ display:flex; }
  .single{ width:100mm; height:150mm; background:#fff; color:#000; position:relative; border:1px solid #d1d5db; border-radius:8px; }
  .single .label-box{ inset:7mm; border-width:1.4px; padding:4.5mm }
</style>
</head>
<body>
  <header>
    <div class="page">
      <h1>Generador de Etiquetas (10×15 cm) • GoSpin (v1.9.4)</h1>
    </div>
  </header>

  <main>
    <div class="page">
      <!-- IZQUIERDA -->
      <section class="card form-card printable">
        <div class="card-body">

          <div class="options">
            <div class="group">
              <strong style="font-size:12px; color:#0f172a; display:block; margin-bottom:6px;">Formato</strong>
              <label><input type="radio" name="pdfsize" value="a4x4_95" checked> A4 · 4 etiquetas por hoja</label>
              <label><input type="radio" name="pdfsize" value="10x15"> Térmica 10×15</label>
            </div>
          </div>

          <!-- Selector 1–4 -->
          <div class="selector" id="selector"></div>

          <!-- Aviso “Siguiente etiqueta” -->
          <div id="next-hint" class="hint" style="display:none">
            <span><b>Etiqueta completa.</b> ¿Querés cargar la próxima?</span>
            <button class="go" id="btn-next-hint">Ir a la siguiente</button>
          </div>

          <!-- Errores -->
          <div id="error-box" class="alert" role="alert" aria-live="polite">
            <p class="alert-title">
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M11.001 10h2v5h-2v-5zm0 6h2v2h-2v-2z"/><path d="M1 21h22L12 2 1 21z"/></svg>
              <span>Faltan completar los siguientes campos:</span>
            </p>
            <ul id="error-list"></ul>
          </div>

          <!-- Form -->
          <div class="field">
            <label>REMITENTE</label>
            <input id="f-remitente" maxlength="64" placeholder="(Ingresar únicamente nombre de comercio)"/>
          </div>
          <div class="field">
            <label>NOMBRE COMPLETO DE QUIEN RECIBE</label>
            <input id="f-nombre" maxlength="64" placeholder="(Nombre y Apellido)"/>
          </div>
          <div class="field">
            <label>DOMICILIO</label>
            <input id="f-domicilio" maxlength="90" placeholder="(Calle, Número, Piso/Departamento)"/>
          </div>
          <div class="row">
            <div class="field">
              <label>LOCALIDAD</label>
              <input id="f-localidad" maxlength="48" placeholder="(Ciudad/Localidad)"/>
            </div>
            <div class="field">
              <label>CÓDIGO POSTAL</label>
              <input id="f-cp" inputmode="numeric" maxlength="4" placeholder="(4 dígitos, ej. 1602)"/>
            </div>
          </div>
          <div class="field">
            <label>CELULAR</label>
            <input id="f-cel" inputmode="numeric" maxlength="15" placeholder="(Sólo números, sin + ni guiones)"/>
          </div>
          <div class="field">
            <label>OBSERVACIONES</label>
            <textarea id="f-obs" rows="3" maxlength="220" placeholder="(Frágil, horario de entrega, portería, etc.)"></textarea>
          </div>

          <div class="actions">
            <button id="btn-pdf">Descargar PDF</button>
            <button id="btn-next" class="secondary">Siguiente etiqueta</button>
            <button id="btn-clear" class="secondary">Borrar todo</button>
          </div>
          <p style="font-size:12px; color:#475569; margin:2px 0 0">
            Todos los campos son obligatorios salvo Observaciones. Los datos no se envían a ningún servidor.
          </p>
        </div>
      </section>

      <!-- DERECHA -->
      <section class="card preview-card">
        <div class="card-body">
          <div class="status">
            <span>Etiqueta activa: <b id="active-label">1</b> / 4</span>
            <span>•</span>
            <span>A4: se imprimen sólo las etiquetas completas.</span>
          </div>

          <!-- A4 -->
          <div class="preview-wrap" id="a4-area">
            <div id="slots" class="slots"></div>
          </div>

          <!-- Térmica -->
          <div class="preview-wrap" id="single-area" style="display:none">
            <div class="single-wrap">
              <div class="single" id="single-preview">
                <div class="label-box">
                  <div class="brand-row">
                    <div class="brand-left">
                      <div class="brand-title">Etiqueta de Envío • GoSpin</div>
                      <div class="brand-date" id="v-fecha"></div>
                    </div>
                    <img src="gospinlogo.png" alt="GoSpin" class="brand-logo" />
                  </div>
                  <div class="fieldbox remitente"><div class="flabel">REMITENTE</div><div class="box" id="v-remitente"></div></div>
                  <div class="fieldbox nombre"><div class="flabel">NOMBRE COMPLETO DE QUIEN RECIBE</div><div class="box" id="v-nombre"></div></div>
                  <div class="fieldbox domicilio"><div class="flabel">DOMICILIO</div><div class="box" id="v-domicilio"></div></div>
                  <div class="row2">
                    <div class="fieldbox loc"><div class="flabel">LOCALIDAD</div><div class="box" id="v-localidad"></div></div>
                    <div class="fieldbox cp"><div class="flabel">CÓDIGO POSTAL</div><div class="box" id="v-cp"></div></div>
                  </div>
                  <div class="fieldbox cel"><div class="flabel">CELULAR</div><div class="box" id="v-cel"></div></div>
                  <div class="fieldbox obs"><div class="flabel">OBSERVACIONES</div><div class="box" id="v-obs"></div></div>
                  <div class="website">WWW.GOSPIN.COM.AR</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

    </div>
  </main>

<script>
/* Utilidades */
function $(id){return document.getElementById(id);}
function q(sel){return document.querySelector(sel);}
function qa(sel){return Array.from(document.querySelectorAll(sel));}
function getVal(id){return ($(id).value||'').trim();}
function toUC(s){ return (s||'').toUpperCase(); }
function setInvalid(id,on){$(id).classList.toggle('invalid',!!on);}

/* Fecha Argentina (DD/MM/AAAA) */
function todayAR(){
  const d=new Date();
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yy=d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
let CURRENT_DATE = todayAR();

const MODE_A4='a4x4_95';
const MODE_TH='10x15';

let activeIndex=0; // 0..3
const labels=[empty(),empty(),empty(),empty()];

function empty(){ return {remitente:'',nombre:'',domicilio:'',localidad:'',cp:'',cel:'',obs:'',fecha:CURRENT_DATE}; }

function validateData(d){
  const m=[];
  if(!d.remitente) m.push('Remitente');
  if(!d.nombre)    m.push('Nombre completo de quien recibe');
  if(!d.domicilio) m.push('Domicilio');
  if(!d.localidad) m.push('Localidad');
  if(!/^\d{4}$/.test(d.cp)) m.push('Código Postal (4 dígitos)');
  if(!/^\d{1,15}$/.test(d.cel)) m.push('Celular (sólo números, hasta 15 dígitos)');
  return {ok:m.length===0, missing:m};
}

function renderErrors(list){
  const box=$('error-box'), ul=$('error-list');
  if(!list || list.length===0){ box.style.display='none'; ul.innerHTML=''; return; }
  ul.innerHTML=list.map(t=>`<li>${t}</li>`).join('');
  box.style.display='block';
}

/* Inputs numéricos */
$('f-cp').addEventListener('input',e=>{ e.target.value=e.target.value.replace(/[^0-9]/g,'').slice(0,4); });
$('f-cel').addEventListener('input',e=>{ e.target.value=e.target.value.replace(/[^0-9]/g,'').slice(0,15); });

/* Selector UI */
function buildSelector(){
  const el=$('selector'); el.innerHTML='';
  for(let i=0;i<4;i++){
    const tag=document.createElement('button');
    tag.type='button'; tag.className='tag'; tag.dataset.index=String(i);
    tag.innerHTML=`<span class="dot" id="sel-dot-${i}"></span> Etiqueta ${i+1} <small id="sel-state-${i}"></small>`;
    tag.addEventListener('click',()=>{ setActive(i,true); });
    el.appendChild(tag);
  }
  updateSelectorStatus();
}
function updateSelectorStatus(){
  for(let i=0;i<4;i++){
    const d=labels[i], v=validateData(d);
    const dot=$('sel-dot-'+i), st=$('sel-state-'+i);
    dot.className='dot'+(v.ok?' ok':(i===activeIndex?' edit':'')); // verde si OK, celeste si activa
    st.textContent = v.ok ? 'completa' : (i===activeIndex?'(editando)':'');
  }
  qa('.selector .tag').forEach(b=>b.classList.toggle('active', Number(b.dataset.index)===activeIndex));
}

/* Slots A4 con fecha debajo del título */
function buildSlot(i){
  const slot=document.createElement('div');
  slot.className='label-preview';
  slot.dataset.index=String(i);
  slot.innerHTML=`
    <div class="badge">#${i+1}</div>
    <div class="label-box">
      <div class="brand-row">
        <div class="brand-left">
          <div class="brand-title">Etiqueta de Envío • GoSpin</div>
          <div class="brand-date" id="p${i}-fecha"></div>
        </div>
        <img src="gospinlogo.png" alt="GoSpin" class="brand-logo" />
      </div>
      <div class="fieldbox remitente"><div class="flabel">REMITENTE</div><div class="box" id="p${i}-remitente"></div></div>
      <div class="fieldbox nombre"><div class="flabel">NOMBRE COMPLETO DE QUIEN RECIBE</div><div class="box" id="p${i}-nombre"></div></div>
      <div class="fieldbox domicilio"><div class="flabel">DOMICILIO</div><div class="box" id="p${i}-domicilio"></div></div>
      <div class="row2">
        <div class="fieldbox loc"><div class="flabel">LOCALIDAD</div><div class="box" id="p${i}-localidad"></div></div>
        <div class="fieldbox cp"><div class="flabel">CÓDIGO POSTAL</div><div class="box" id="p${i}-cp"></div></div>
      </div>
      <div class="fieldbox cel"><div class="flabel">CELULAR</div><div class="box" id="p${i}-cel"></div></div>
      <div class="fieldbox obs"><div class="flabel">OBSERVACIONES</div><div class="box" id="p${i}-obs"></div></div>
      <div class="website">WWW.GOSPIN.COM.AR</div>
    </div>
    <div class="placeholder" id="p${i}-ph"><div><b>Etiqueta vacía</b><br/>Clic para completar esta etiqueta</div></div>
  `;
  slot.addEventListener('click',()=>setActive(i,true));
  return slot;
}

function initSlots(){
  const wrap=$('slots'); wrap.innerHTML='';
  for(let i=0;i<4;i++) wrap.appendChild(buildSlot(i));
  setActive(0,false);
  syncAllSlots();
}

/* Estado activo */
function setActive(i,loadForm){
  activeIndex=i;
  $('active-label').textContent=String(i+1);
  qa('.label-preview').forEach(el=>el.classList.toggle('active', el.dataset.index==i));
  if(loadForm) loadFormFromData(labels[i]);
  updateSelectorStatus();
  maybeShowNextHint();
}

function loadFormFromData(d){
  $('f-remitente').value=d.remitente||'';
  $('f-nombre').value   =d.nombre||'';
  $('f-domicilio').value=d.domicilio||'';
  $('f-localidad').value=d.localidad||'';
  $('f-cp').value       =d.cp||'';
  $('f-cel').value      =d.cel||'';
  $('f-obs').value      =d.obs||'';
  renderErrors([]); qa('.invalid').forEach(el=>el.classList.remove('invalid'));
}

/* Form -> modelo -> preview (mayúsculas) + fecha */
function syncActiveFromForm(){
  const i=activeIndex, d=labels[i];
  d.remitente=toUC(getVal('f-remitente'));
  d.nombre   =toUC(getVal('f-nombre'));
  d.domicilio=toUC(getVal('f-domicilio'));
  d.localidad=toUC(getVal('f-localidad'));
  d.cp       =getVal('f-cp');
  d.cel      =getVal('f-cel');
  d.obs      =toUC(getVal('f-obs'));
  d.fecha    = CURRENT_DATE;

  ['remitente','nombre','domicilio','localidad','cp','cel','obs','fecha'].forEach(k=>{
    const el=$(`p${i}-${k}`); if(el) el.textContent=d[k]||'';
  });
  const empty=!d.remitente && !d.nombre && !d.domicilio && !d.localidad && !d.cp && !d.cel && !d.obs;
  const ph=$(`p${i}-ph`); if(ph) ph.style.display=empty?'flex':'none';

  if(validateData(d).ok) renderErrors([]);
  updateSelectorStatus();
  maybeShowNextHint();
}
['f-remitente','f-nombre','f-domicilio','f-localidad','f-cp','f-cel','f-obs'].forEach(id=>{
  $(id).addEventListener('input', syncActiveFromForm);
});

/* Hint siguiente */
function maybeShowNextHint(){
  const d=labels[activeIndex], v=validateData(d);
  const hint=$('next-hint');
  const hasNext = activeIndex<3;
  hint.style.display = (v.ok && hasNext) ? 'block' : 'none';
}
$('btn-next-hint').addEventListener('click', ()=> goNext());

/* Siguiente etiqueta */
function goNext(){
  const next = Math.min(3, activeIndex+1);
  setActive(next,true);
  $('f-remitente').focus();
}
$('btn-next').addEventListener('click', goNext);

/* Modo preview */
function updateModeUI(){
  const mode=(q('input[name="pdfsize"]:checked')||{}).value||MODE_A4;
  const isA4=(mode===MODE_A4);
  $('a4-area').style.display=isA4?'':'none';
  $('single-area').style.display=isA4?'none':'';
  if(!isA4){
    $('v-remitente').textContent=toUC(getVal('f-remitente'));
    $('v-nombre').textContent   =toUC(getVal('f-nombre'));
    $('v-domicilio').textContent=toUC(getVal('f-domicilio'));
    $('v-localidad').textContent=toUC(getVal('f-localidad'));
    $('v-cp').textContent       =getVal('f-cp');
    $('v-fecha').textContent    =CURRENT_DATE;
    $('v-cel').textContent      =getVal('f-cel');
    $('v-obs').textContent      =toUC(getVal('f-obs'));
  }
}
qa('input[name="pdfsize"]').forEach(r=>r.addEventListener('change', updateModeUI));

/* Borrar todo */
$('btn-clear').addEventListener('click', ()=>{
  ['f-remitente','f-nombre','f-domicilio','f-localidad','f-cp','f-cel','f-obs'].forEach(id=>{ $(id).value=''; setInvalid(id,false); });
  renderErrors([]);
  for(let i=0;i<4;i++) labels[i]=empty();
  syncAllSlots();
  setActive(0,false);
  $('f-remitente').focus();
});

/* Descargar PDF */
$('btn-pdf').addEventListener('click', descargarPDF);

async function descargarPDF(){
  // Actualizar fecha por si cambió el día
  CURRENT_DATE = todayAR();
  for(let i=0;i<4;i++){ labels[i].fecha=CURRENT_DATE; }
  syncAllSlots();

  const { jsPDF }=window.jspdf;
  const mode=(q('input[name="pdfsize"]:checked')||{}).value||MODE_A4;

  if(mode===MODE_TH){
    const d={
      remitente:toUC(getVal('f-remitente')),
      nombre:toUC(getVal('f-nombre')),
      domicilio:toUC(getVal('f-domicilio')),
      localidad:toUC(getVal('f-localidad')),
      cp:getVal('f-cp'),
      cel:getVal('f-cel'),
      obs:toUC(getVal('f-obs')),
      fecha:CURRENT_DATE
    };
    const v=validateData(d); if(!v.ok){ renderErrors(v.missing); return; }
    renderErrors([]);
    // volcar al preview térmico
    $('v-remitente').textContent=d.remitente;
    $('v-nombre').textContent   =d.nombre;
    $('v-domicilio').textContent=d.domicilio;
    $('v-localidad').textContent=d.localidad;
    $('v-cp').textContent       =d.cp;
    $('v-fecha').textContent    =d.fecha;
    $('v-cel').textContent      =d.cel;
    $('v-obs').textContent      =d.obs;

    const pv=$('single-preview'), prev=pv.style.transform; pv.style.transform='none';
    const canvas=await html2canvas(pv,{scale:2,backgroundColor:'#fff'});
    const img=canvas.toDataURL('image/png');
    const pdf=new jsPDF({orientation:'p', unit:'mm', format:[100,150]});
    pdf.addImage(img,'PNG',0,0,100,150);
    const nombre=(d.nombre.replace(/[^A-Za-z0-9_\-]+/g,'_'))||'etiqueta';
    const cp=d.cp||'0000';
    pdf.save(`etiqueta_gospin_${cp}_${nombre}_10x15.pdf`);
    pv.style.transform=prev;
    return;
  }

  // A4
  syncActiveFromForm();
  const completeIdx = labels.map((d,i)=>({i,d,v:validateData(d)})).filter(x=>x.v.ok).map(x=>x.i);
  if(completeIdx.length===0){ renderErrors(['Completá al menos una etiqueta (todos los campos obligatorios).']); return; }

  const pdf=new jsPDF({orientation:'p', unit:'mm', format:'a4'});
  const pageW=210, pageH=297;
  const W=95, H=142.5, gutterX=10, gutterY=10;
  const left=(pageW-(W*2+gutterX))/2;
  const top =(pageH-(H*2+gutterY))/2;

  async function slotToImage(idx){
    // clonar y sacar placeholder + badge (número solo pantalla)
    const node=qa('.label-preview')[idx].cloneNode(true);
    const ph=node.querySelector('.placeholder'); if(ph) ph.remove();
    const bd=node.querySelector('.badge'); if(bd) bd.remove();
    node.style.position='fixed'; node.style.left='-9999px'; node.style.top='-9999px';
    document.body.appendChild(node);
    const canvas=await html2canvas(node,{scale:2,backgroundColor:'#fff'});
    document.body.removeChild(node);
    return canvas.toDataURL('image/png');
  }

  for(let n=0;n<completeIdx.length;n++){
    if(n>0 && n%4===0) pdf.addPage('a4','p');
    const slot=n%4, row=Math.floor(slot/2), col=slot%2;
    const x=left + col*(W+gutterX);
    const y=top  + row*(H+gutterY);
    const img=await slotToImage(completeIdx[n]);
    pdf.addImage(img,'PNG',x,y,W,H);
  }

  pdf.save(`etiquetas_gospin_A4x4.pdf`);
}

/* Sync all previews (incluye FECHA) */
function syncAllSlots(){
  for(let i=0;i<4;i++){
    const d=labels[i];
    if(!d.fecha) d.fecha=CURRENT_DATE;
    ['remitente','nombre','domicilio','localidad','cp','cel','obs','fecha'].forEach(k=>{
      const el=$(`p${i}-${k}`); if(el) el.textContent=d[k]||'';
    });
    const empty=!d.remitente && !d.nombre && !d.domicilio && !d.localidad && !d.cp && !d.cel && !d.obs;
    const ph=$(`p${i}-ph`); if(ph) ph.style.display=empty?'flex':'none';
  }
  updateSelectorStatus();
}

/* Init */
function init(){
  buildSelector();
  initSlots();
  updateModeUI();
  $('f-remitente').focus();
  // setear fecha visible de entrada
  for(let i=0;i<4;i++){ const el=$(`p${i}-fecha`); if(el) el.textContent=CURRENT_DATE; }
  if($('v-fecha')) $('v-fecha').textContent = CURRENT_DATE;
}
init();
</script>
</body>
</html>
